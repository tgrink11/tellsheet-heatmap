<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kerry's Tell Sheet Heat Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #131722;
      color: #d1d4dc;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: #1e222d;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      border-bottom: 1px solid #2a2e39;
    }

    .header h1 {
      font-size: 1.4rem;
      font-weight: 600;
      color: #fff;
    }

    .header-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .header select, .header button {
      background: #2a2e39;
      color: #d1d4dc;
      border: 1px solid #363a45;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .header select:hover, .header button:hover {
      background: #363a45;
    }

    .header button.refresh {
      background: #2962ff;
      border-color: #2962ff;
      color: #fff;
    }

    .header button.refresh:hover {
      background: #1e4bd8;
    }

    .status {
      font-size: 0.75rem;
      color: #787b86;
    }

    /* Main Content */
    .main-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 60px);
      padding: 10px 40px; /* Added side padding */
    }

    /* Treemap Container */
    #treemap {
      flex: 1;
      padding: 8px;
      overflow: hidden;
      background: #131722;
    }

    /* Treemap Cells */
    .cell {
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .cell:hover {
      opacity: 0.8;
    }

    .cell rect {
      stroke: #1e222d;
      stroke-width: 1.5px;
    }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: #1e222d;
      border: 1px solid #363a45;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 0.85rem;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      max-width: 280px;
    }

    .tooltip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #363a45;
    }

    .tooltip-ticker {
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
    }

    .tooltip-change {
      font-size: 1rem;
      font-weight: 600;
    }

    .tooltip-name {
      color: #787b86;
      margin-bottom: 8px;
      font-size: 0.8rem;
    }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }

    .tooltip-label {
      color: #787b86;
    }

    .tooltip-value {
      color: #d1d4dc;
      font-weight: 500;
    }

    /* Legend */
    .legend {
      background: #1e222d;
      padding: 8px 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 4px;
      border-top: 1px solid #2a2e39;
      flex-wrap: wrap;
    }

    .legend-item {
      width: 36px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 600;
      border-radius: 2px;
    }

    /* Loading Overlay */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(19, 23, 34, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .loading-content {
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #2a2e39;
      border-top-color: #2962ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* View Buttons */
    .view-buttons {
      display: flex;
      gap: 4px;
    }

    .view-btn {
      background: #2a2e39;
      color: #d1d4dc;
      border: 1px solid #363a45;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .view-btn.active {
      background: #2962ff;
      border-color: #2962ff;
      color: #fff;
    }

    .view-btn:hover:not(.active) {
      background: #363a45;
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .header {
        padding: 8px 12px;
      }
      
      .header h1 {
        font-size: 1.1rem;
      }
      
      .header select, .header button, .view-btn {
        padding: 5px 8px;
        font-size: 0.75rem;
      }
      
      .legend-item {
        width: 30px;
        height: 18px;
        font-size: 0.55rem;
      }

      .main-container {
        padding: 5px 10px;
      }
    }

    /* Control Group */
    .control-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .control-label {
      font-size: 0.75rem;
      color: #787b86;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading" id="loading">
    <div class="loading-content">
      <div class="spinner"></div>
      <div>Loading stock data...</div>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <h1>ðŸ“Š Kerry's Tell Sheet Heat Map</h1>
    <div class="header-controls">
      <div class="view-buttons">
        <button class="view-btn active" data-view="sector">Sector</button>
        <button class="view-btn" data-view="marketcap">Mkt Cap</button>
        <button class="view-btn" data-view="performance">Perf</button>
      </div>
      
      <div class="control-group">
        <select id="sizeBy" title="Size boxes by">
          <option value="balanced">Size: Balanced</option>
          <option value="log">Size: Log Scale</option>
          <option value="sqrt">Size: Square Root</option>
          <option value="equal">Size: Equal</option>
          <option value="marketcap">Size: Market Cap</option>
        </select>
      </div>

      <div class="control-group">
        <select id="colorBy" title="Color boxes by">
          <option value="daily">Color: Daily %</option>
          <option value="ytd">Color: YTD %</option>
        </select>
      </div>

      <button class="refresh" onclick="refreshData()">ðŸ”„ Refresh</button>
      <span class="status" id="status">Loading...</span>
    </div>
  </header>

  <!-- Main Treemap -->
  <div class="main-container">
    <div id="treemap"></div>
  </div>

  <!-- Legend -->
  <div class="legend" id="legend"></div>

  <!-- Tooltip -->
  <div class="tooltip hidden" id="tooltip"></div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const API_KEY = 'e0enTj1fVE1n8IVYZaFKj6P5nfIHYNMM';
    
    const TICKERS = [
      "AEHR", "AFRM", "ANET", "APP", "ARM", "ASML", "ASTS", "AVAV", "AVGO", "BE",
      "BOX", "CFLT", "CRCL", "CRWD", "CYBR", "EOSE", "FIX", "GEV", "HIMS", "HSAI",
      "IBM", "LITE", "INTC", "MRVL", "KTOS", "KVYO", "MELI", "MDB", "MNDY", "MOD",
      "NVTS", "NOW", "NU", "ON", "ONDS", "ORCL", "PERF", "PANW", "PLTR", "PSIX",
      "QCOM", "QNST", "RDDT", "RKLB", "S", "SEI", "SHOP", "SITM", "SMR", "SNOW",
      "SNPS", "SOFI", "SOUN", "SYM", "TGTX", "TSEM", "UBER", "UCTT", "UPST", "VICR",
      "VRT", "WDC", "WULF", "XYZ", "ZS", "ZETA", "AAPL", "AMD", "AMKR", "AMPX",
      "AMZN", "APLD", "CLS", "COHR", "CRDO", "CRWV", "GLBE", "GLXY", "GOOG", "IREN",
      "MARA", "META", "MSFT", "MU", "NBIS", "NVDA", "PPSI", "QXO", "RBRK", "RMBS",
      "SE", "SKYT", "SMCI", "TSLA", "TSM", "UEC", "RIOT", "CIFR", "CLSK", "HIVE",
      "HUT", "CORZ", "HIMS"
    ];

    const SECTORS = {
      "Big Tech": ["AAPL", "MSFT", "GOOG", "META", "AMZN", "IBM"],
      "Semiconductors": ["NVDA", "AMD", "AVGO", "QCOM", "ARM", "MRVL", "INTC", "MU", "ASML", "TSM", "SMCI", "AEHR", "ON", "AMKR", "COHR", "CRDO", "RMBS", "SITM", "UCTT", "LITE", "TSEM"],
      "Cloud & Software": ["NOW", "SNOW", "MDB", "CRWD", "PANW", "ZS", "CYBR", "CFLT", "MNDY", "BOX", "PLTR", "ORCL", "S", "KVYO", "SNPS", "ANET"],
      "E-Commerce & Fintech": ["SHOP", "MELI", "NU", "SE", "UBER", "HIMS", "SOFI", "AFRM", "UPST", "RDDT"],
      "Energy & Clean Tech": ["BE", "EOSE", "SMR", "GEV", "VRT", "AMPX", "UEC", "TSLA"],
      "Space & Defense": ["RKLB", "ASTS", "AVAV", "KTOS"],
      "Crypto & Mining": ["MARA", "RIOT", "CIFR", "CLSK", "HIVE", "HUT", "CORZ", "IREN", "WULF", "GLXY"],
      "Other Tech": ["APP", "CLS", "FIX", "MOD", "NBIS", "NVTS", "QXO", "RBRK", "SKYT", "SYM", "TGTX", "VICR", "WDC", "XYZ", "ZETA", "APLD", "CRWV", "GLBE", "HSAI", "PPSI", "PSIX", "QNST", "SEI", "SOUN", "CRCL", "ONDS", "PERF", "HIMS"]
    };

    // Color scales
    const DAILY_COLORS = [
      { threshold: -3, color: '#B71C1C' },
      { threshold: -2, color: '#D32F2F' },
      { threshold: -1, color: '#E53935' },
      { threshold: -0.5, color: '#EF5350' },
      { threshold: 0.5, color: '#37474F' },
      { threshold: 1, color: '#4DB6AC' },
      { threshold: 2, color: '#26A69A' },
      { threshold: 3, color: '#00E676' },
      { threshold: Infinity, color: '#00C853' }
    ];

    const YTD_COLORS = [
      { threshold: -50, color: '#B71C1C' },
      { threshold: -30, color: '#D32F2F' },
      { threshold: -15, color: '#E53935' },
      { threshold: -5, color: '#EF5350' },
      { threshold: 5, color: '#37474F' },
      { threshold: 15, color: '#4DB6AC' },
      { threshold: 30, color: '#26A69A' },
      { threshold: 50, color: '#00E676' },
      { threshold: Infinity, color: '#00C853' }
    ];

    // State
    let stockData = [];
    let ytdData = {};
    let currentView = 'sector';
    let colorBy = 'daily';
    let sizeBy = 'balanced';

    // ============================================
    // API FUNCTIONS
    // ============================================
    async function fetchStockData() {
      const batchSize = 50;
      const allData = [];

      for (let i = 0; i < TICKERS.length; i += batchSize) {
        const batch = TICKERS.slice(i, i + batchSize);
        const symbols = batch.join(',');
        const url = `https://financialmodelingprep.com/api/v3/quote/${symbols}?apikey=${API_KEY}`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          if (Array.isArray(data)) {
            allData.push(...data);
          }
        } catch (error) {
          console.error('Error fetching stock data:', error);
        }
      }

      return allData;
    }

    async function fetchYTDData() {
      const batchSize = 50;
      const allData = {};

      for (let i = 0; i < TICKERS.length; i += batchSize) {
        const batch = TICKERS.slice(i, i + batchSize);
        const symbols = batch.join(',');
        const url = `https://financialmodelingprep.com/api/v3/stock-price-change/${symbols}?apikey=${API_KEY}`;

        try {
          const response = await fetch(url);
          const data = await response.json();
          if (Array.isArray(data)) {
            data.forEach(item => {
              allData[item.symbol] = item;
            });
          }
        } catch (error) {
          console.error('Error fetching YTD data:', error);
        }
      }

      return allData;
    }

    // ============================================
    // COLOR FUNCTIONS
    // ============================================
    function getColor(value, type = 'daily') {
      const colors = type === 'daily' ? DAILY_COLORS : YTD_COLORS;
      
      for (const item of colors) {
        if (value < item.threshold) {
          return item.color;
        }
      }
      return colors[colors.length - 1].color;
    }

    function getTextColor(bgColor) {
      const hex = bgColor.replace('#', '');
      const r = parseInt(hex.substr(0, 2), 16);
      const g = parseInt(hex.substr(2, 2), 16);
      const b = parseInt(hex.substr(4, 2), 16);
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#000000' : '#FFFFFF';
    }

    // ============================================
    // SIZE CALCULATION - IMPROVED
    // ============================================
    function getSizeValue(stock) {
      const marketCap = stock.marketCap || 1000000;
      
      // Find min and max market caps for normalization
      const allCaps = stockData.map(s => s.marketCap || 1000000);
      const minCap = Math.min(...allCaps);
      const maxCap = Math.max(...allCaps);
      
      switch (sizeBy) {
        case 'equal':
          return 1;
        
        case 'balanced':
          // New balanced mode - compresses the range significantly
          // Large caps are only ~3-4x bigger than small caps instead of 1000x
          const logVal = Math.log10(marketCap);
          const logMin = Math.log10(minCap);
          const logMax = Math.log10(maxCap);
          const normalized = (logVal - logMin) / (logMax - logMin); // 0 to 1
          // Map to range where smallest is 1 and largest is 4
          return 1 + (normalized * 3);
        
        case 'sqrt':
          // Square root - moderate compression
          const sqrtNorm = (Math.sqrt(marketCap) - Math.sqrt(minCap)) / (Math.sqrt(maxCap) - Math.sqrt(minCap));
          return 1 + (sqrtNorm * 6);
        
        case 'log':
          // Log scale - more compression than sqrt
          const logNorm = (Math.log10(marketCap) - Math.log10(minCap)) / (Math.log10(maxCap) - Math.log10(minCap));
          return 1 + (logNorm * 8);
        
        case 'marketcap':
        default:
          return marketCap;
      }
    }

    // ============================================
    // DATA PROCESSING
    // ============================================
    function buildHierarchy(view) {
      const dataMap = {};
      stockData.forEach(s => { dataMap[s.symbol] = s; });

      if (view === 'sector') {
        const children = [];
        
        for (const [sector, tickers] of Object.entries(SECTORS)) {
          const stocks = tickers
            .map(t => dataMap[t])
            .filter(s => s)
            .map(s => ({
              name: s.symbol,
              value: getSizeValue(s),
              data: s,
              ytd: ytdData[s.symbol]?.ytd || 0
            }));

          if (stocks.length > 0) {
            stocks.sort((a, b) => b.value - a.value);
            children.push({
              name: sector,
              children: stocks
            });
          }
        }

        children.sort((a, b) => {
          const aTotal = a.children.reduce((sum, c) => sum + c.value, 0);
          const bTotal = b.children.reduce((sum, c) => sum + c.value, 0);
          return bTotal - aTotal;
        });

        return { name: 'root', children };
      } 
      else if (view === 'marketcap') {
        const tiers = {
          'Mega Cap ($200B+)': [],
          'Large Cap ($10B-$200B)': [],
          'Mid Cap ($2B-$10B)': [],
          'Small Cap (<$2B)': []
        };

        stockData.forEach(s => {
          if (!s.marketCap) return;
          const stock = {
            name: s.symbol,
            value: getSizeValue(s),
            data: s,
            ytd: ytdData[s.symbol]?.ytd || 0
          };

          if (s.marketCap >= 200e9) tiers['Mega Cap ($200B+)'].push(stock);
          else if (s.marketCap >= 10e9) tiers['Large Cap ($10B-$200B)'].push(stock);
          else if (s.marketCap >= 2e9) tiers['Mid Cap ($2B-$10B)'].push(stock);
          else tiers['Small Cap (<$2B)'].push(stock);
        });

        const children = Object.entries(tiers)
          .filter(([_, stocks]) => stocks.length > 0)
          .map(([name, stocks]) => {
            stocks.sort((a, b) => b.value - a.value);
            return { name, children: stocks };
          });

        return { name: 'root', children };
      }
      else if (view === 'performance') {
        const tiers = {
          'ðŸš€ Hot (+5%+)': [],
          'ðŸ“ˆ Gaining (+2% to +5%)': [],
          'âœ… Up (0% to +2%)': [],
          'â¬‡ï¸ Down (-2% to 0%)': [],
          'ðŸ“‰ Losing (-5% to -2%)': [],
          'ðŸ”¥ Dumping (-5%+)': []
        };

        stockData.forEach(s => {
          if (!s.marketCap) return;
          const pct = s.changesPercentage || 0;
          const stock = {
            name: s.symbol,
            value: getSizeValue(s),
            data: s,
            ytd: ytdData[s.symbol]?.ytd || 0
          };

          if (pct >= 5) tiers['ðŸš€ Hot (+5%+)'].push(stock);
          else if (pct >= 2) tiers['ðŸ“ˆ Gaining (+2% to +5%)'].push(stock);
          else if (pct >= 0) tiers['âœ… Up (0% to +2%)'].push(stock);
          else if (pct >= -2) tiers['â¬‡ï¸ Down (-2% to 0%)'].push(stock);
          else if (pct >= -5) tiers['ðŸ“‰ Losing (-5% to -2%)'].push(stock);
          else tiers['ðŸ”¥ Dumping (-5%+)'].push(stock);
        });

        const children = Object.entries(tiers)
          .filter(([_, stocks]) => stocks.length > 0)
          .map(([name, stocks]) => {
            stocks.sort((a, b) => b.value - a.value);
            return { name, children: stocks };
          });

        return { name: 'root', children };
      }
    }

    // ============================================
    // RENDERING
    // ============================================
    function renderTreemap() {
      const container = document.getElementById('treemap');
      container.innerHTML = '';

      const width = container.clientWidth;
      const height = container.clientHeight;

      const hierarchy = buildHierarchy(currentView);

      const root = d3.hierarchy(hierarchy)
        .sum(d => d.value)
        .sort((a, b) => b.value - a.value);

      const treemap = d3.treemap()
        .size([width, height])
        .paddingTop(22)
        .paddingRight(3)
        .paddingBottom(3)
        .paddingLeft(3)
        .paddingInner(3)
        .round(true);

      treemap(root);

      const svg = d3.select('#treemap')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      // Draw sector backgrounds and labels
      const sectors = root.children || [];
      sectors.forEach(sector => {
        svg.append('rect')
          .attr('x', sector.x0)
          .attr('y', sector.y0)
          .attr('width', sector.x1 - sector.x0)
          .attr('height', sector.y1 - sector.y0)
          .attr('fill', 'none')
          .attr('stroke', '#2a2e39')
          .attr('stroke-width', 1);

        svg.append('text')
          .attr('x', sector.x0 + 6)
          .attr('y', sector.y0 + 15)
          .attr('font-size', '11px')
          .attr('font-weight', '600')
          .attr('fill', '#9598a1')
          .text(sector.data.name);
      });

      // Draw stock cells
      const leaves = root.leaves();

      const cells = svg.selectAll('.cell')
        .data(leaves)
        .enter()
        .append('g')
        .attr('class', 'cell')
        .attr('transform', d => `translate(${d.x0},${d.y0})`);

      cells.append('rect')
        .attr('width', d => Math.max(0, d.x1 - d.x0))
        .attr('height', d => Math.max(0, d.y1 - d.y0))
        .attr('fill', d => {
          const value = colorBy === 'daily' 
            ? (d.data.data?.changesPercentage || 0)
            : (d.data.ytd || 0);
          return getColor(value, colorBy);
        })
        .attr('rx', 2);

      // Add text
      cells.each(function(d) {
        const cellWidth = d.x1 - d.x0;
        const cellHeight = d.y1 - d.y0;
        const cell = d3.select(this);

        const pctValue = colorBy === 'daily'
          ? (d.data.data?.changesPercentage || 0)
          : (d.data.ytd || 0);
        const bgColor = getColor(pctValue, colorBy);
        const textColor = getTextColor(bgColor);

        if (cellWidth < 28 || cellHeight < 22) return;

        const tickerSize = Math.min(
          Math.max(8, Math.floor(cellWidth / 5.5)),
          Math.max(8, Math.floor(cellHeight / 2.8)),
          14
        );

        cell.append('text')
          .attr('x', cellWidth / 2)
          .attr('y', cellHeight / 2 - (cellHeight > 38 ? 6 : 1))
          .attr('text-anchor', 'middle')
          .attr('dominant-baseline', 'middle')
          .attr('font-size', `${tickerSize}px`)
          .attr('font-weight', '700')
          .attr('fill', textColor)
          .text(d.data.name);

        if (cellHeight > 38 && cellWidth > 34) {
          const pctText = (pctValue >= 0 ? '+' : '') + pctValue.toFixed(2) + '%';
          const pctSize = Math.min(tickerSize - 1, 11);
          
          cell.append('text')
            .attr('x', cellWidth / 2)
            .attr('y', cellHeight / 2 + tickerSize / 2 + 5)
            .attr('text-anchor', 'middle')
            .attr('dominant-baseline', 'middle')
            .attr('font-size', `${pctSize}px`)
            .attr('font-weight', '600')
            .attr('fill', textColor)
            .text(pctText);
        }
      });

      cells
        .on('mouseenter', showTooltip)
        .on('mousemove', moveTooltip)
        .on('mouseleave', hideTooltip);
    }

    // ============================================
    // TOOLTIP
    // ============================================
    function showTooltip(event, d) {
      const tooltip = document.getElementById('tooltip');
      const stock = d.data.data;
      const ytd = d.data.ytd || 0;

      if (!stock) return;

      const pctChange = stock.changesPercentage || 0;
      const pctColor = pctChange >= 0 ? '#00C853' : '#EF5350';
      const ytdColor = ytd >= 0 ? '#00C853' : '#EF5350';

      tooltip.innerHTML = `
        <div class="tooltip-header">
          <span class="tooltip-ticker">${stock.symbol}</span>
          <span class="tooltip-change" style="color: ${pctColor}">
            ${pctChange >= 0 ? '+' : ''}${pctChange.toFixed(2)}%
          </span>
        </div>
        <div class="tooltip-name">${stock.name || ''}</div>
        <div class="tooltip-row">
          <span class="tooltip-label">Price</span>
          <span class="tooltip-value">$${(stock.price || 0).toFixed(2)}</span>
        </div>
        <div class="tooltip-row">
          <span class="tooltip-label">Change</span>
          <span class="tooltip-value" style="color: ${pctColor}">
            ${stock.change >= 0 ? '+' : ''}$${(stock.change || 0).toFixed(2)}
          </span>
        </div>
        <div class="tooltip-row">
          <span class="tooltip-label">YTD</span>
          <span class="tooltip-value" style="color: ${ytdColor}">
            ${ytd >= 0 ? '+' : ''}${ytd.toFixed(1)}%
          </span>
        </div>
        <div class="tooltip-row">
          <span class="tooltip-label">Volume</span>
          <span class="tooltip-value">${formatNumber(stock.volume)}</span>
        </div>
        <div class="tooltip-row">
          <span class="tooltip-label">Market Cap</span>
          <span class="tooltip-value">${formatMarketCap(stock.marketCap)}</span>
        </div>
      `;

      tooltip.classList.remove('hidden');
      moveTooltip(event);
    }

    function moveTooltip(event) {
      const tooltip = document.getElementById('tooltip');
      const padding = 15;
      let x = event.clientX + padding;
      let y = event.clientY + padding;

      const rect = tooltip.getBoundingClientRect();
      if (x + rect.width > window.innerWidth) {
        x = event.clientX - rect.width - padding;
      }
      if (y + rect.height > window.innerHeight) {
        y = event.clientY - rect.height - padding;
      }

      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y}px`;
    }

    function hideTooltip() {
      document.getElementById('tooltip').classList.add('hidden');
    }

    // ============================================
    // LEGEND
    // ============================================
    function renderLegend() {
      const legend = document.getElementById('legend');
      const colors = colorBy === 'daily' ? DAILY_COLORS : YTD_COLORS;
      const labels = colorBy === 'daily' 
        ? ['-3%', '-2%', '-1%', '-0.5%', '0%', '+0.5%', '+1%', '+2%', '+3%']
        : ['-50%', '-30%', '-15%', '-5%', '0%', '+5%', '+15%', '+30%', '+50%'];

      legend.innerHTML = colors.map((c, i) => `
        <div class="legend-item" style="background: ${c.color}; color: ${getTextColor(c.color)}">
          ${labels[i]}
        </div>
      `).join('');
    }

    // ============================================
    // UTILITIES
    // ============================================
    function formatNumber(num) {
      if (!num) return '0';
      if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(0);
    }

    function formatMarketCap(num) {
      if (!num) return '$0';
      if (num >= 1e12) return '$' + (num / 1e12).toFixed(2) + 'T';
      if (num >= 1e9) return '$' + (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return '$' + (num / 1e6).toFixed(0) + 'M';
      return '$' + num.toLocaleString();
    }

    function updateStatus(text) {
      document.getElementById('status').textContent = text;
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================
    async function refreshData() {
      document.getElementById('loading').classList.remove('hidden');
      updateStatus('Refreshing...');

      try {
        stockData = await fetchStockData();
        ytdData = await fetchYTDData();
        renderTreemap();
        renderLegend();
        updateStatus(`Updated: ${new Date().toLocaleTimeString()}`);
      } catch (error) {
        updateStatus('Error loading data');
        console.error(error);
      }

      document.getElementById('loading').classList.add('hidden');
    }

    function setupEventListeners() {
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = btn.dataset.view;
          renderTreemap();
        });
      });

      document.getElementById('sizeBy').addEventListener('change', (e) => {
        sizeBy = e.target.value;
        renderTreemap();
      });

      document.getElementById('colorBy').addEventListener('change', (e) => {
        colorBy = e.target.value;
        renderTreemap();
        renderLegend();
      });

      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(renderTreemap, 250);
      });
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
      setupEventListeners();
      await refreshData();
      setInterval(refreshData, 5 * 60 * 1000);
    }

    init();
  </script>
</body>
</html>
